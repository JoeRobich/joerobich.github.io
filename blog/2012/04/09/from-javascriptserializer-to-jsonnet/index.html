
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>From JavaScriptSerializer to JSON.Net - Joey Robichaud</title>
  <meta name="author" content="Joey Robichaud">

  
  <meta name="description" content="This post originally appeared on The DevStop and has been migrated here via a quick and dirty script. Please forgive any encoding issues. Recently I &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.joeyrobichaud.com/blog/2012/04/09/from-javascriptserializer-to-jsonnet">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Joey Robichaud" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Joey Robichaud</a></h1>
  
    <h2>code and thoughts</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.joeyrobichaud.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">From JavaScriptSerializer to JSON.Net</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-09T00:00:00-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><!-- more -->


<p><em>This post originally appeared on <a href="http://thedevstop.wordpress.com/2012/04/09/from-javascriptserializer-to-jsonnet/">The DevStop</a> and has been migrated here via a quick and dirty script. Please forgive any encoding issues.</em></p>

<p>Recently I was in charge of replacing the JSON serializers being used in an existing project to squeeze out a little better performance. I looked at a couple libraries for .Net and settled on the almost ubiquitous <a href="http://json.codeplex.com/" title="JSON.Net">JSON.Net</a>. This decision felt even more right after it was announced that JSON.Net will become the default serializer for ASP.Net.</p>

<p>A few thoughts were guiding me in this process:</p>

<ul>
<li>I am not intimately familiar with JSON.Net</li>
<li>I didn&#8217;t have a lot of time to become familiar with it</li>
<li>I had lots of code in the project that used the serializer directly</li>
<li>I need to port several JavaScriptConverters over to equivalent JSON.Net JsonConverters</li>
</ul>


<p>With this in mind, I choose to abstract out the differences instead of attempt a wholesale rewrite. The first task was to create a set of interfaces that roughly resembled the JavaScriptSerializer and JavaScriptConverter classes.</p>

<p>[sourcecode language=&ldquo;csharp&rdquo;]</p>

<p>public interface IJsonSerializer
{</p>

<pre><code>void RegisterConverters(IEnumerable&amp;lt;IJsonConverter&amp;gt; converters);
T ConvertToType&amp;lt;T&amp;gt;(IDictionary&amp;lt;string, object&amp;gt; dictionary);
T Deserialize&amp;lt;T&amp;gt;(string input);
string Serialize(object obj);
string DefaultSerialize(object obj);
</code></pre>

<p>}</p>

<p>[/sourcecode]</p>

<p>[sourcecode language=&ldquo;csharp&rdquo;]</p>

<p>public interface IJsonConverter
{</p>

<pre><code>object Deserialize(IDictionary&amp;lt;string, object&amp;gt; dictionary, Type type, IJsonSerializer serializer);
IDictionary&amp;lt;string, object&amp;gt; Serialize(object obj, IJsonSerializer serializer);
IEnumerable&amp;lt;Type&amp;gt; SupportedTypes { get; }
</code></pre>

<p>}</p>

<p>[/sourcecode]</p>

<p>Next, I made a JSON.Net JsonConverter that will wrap my existing converter classes that now implement IJsonConverter. It handles serializing and deserializing into a Dictionary before passing off to the legacy JavaScriptSerializer code.</p>

<p>Since I needed to get up and running fast, I borrowed the ExpandoObjectConverter class from JSON.Net and tweaked it to build out a Dictionary instead. I could then invoke the IJsonConverter class to take the serialization the rest of the way.</p>

<p>[sourcecode language=&ldquo;csharp&rdquo;]</p>

<p>public class NewtonsoftJsonConverter : JsonConverter
{</p>

<pre><code>private IJsonConverter _converter = null;
private IJsonSerializer _serializer = null;

public NewtonsoftJsonConverter(IJsonSerializer serializer, IJsonConverter converter)
{
    _serializer = serializer;
    _converter = converter;
}

public override bool CanConvert(Type objectType)
{
    foreach (Type type in _converter.SupportedTypes)
        if (type.IsAssignableFrom(objectType))
            return true;

    return false;
}

public override object ReadJson(JsonReader reader, Type objectType, object existingValue, JsonSerializer serializer)
{
    object value = ReadValue(reader);

    if (value == null)
        return value;

    if (!(value is IDictionary&amp;lt;string, object&amp;gt;))
        throw new Exception(&amp;quot;Expected dictionary but found a list&amp;quot;);

    value = _converter.Deserialize((IDictionary&amp;lt;string, object&amp;gt;)value, objectType, _serializer);

    return value;
}

private object ReadValue(JsonReader reader)
{
    while (reader.TokenType == JsonToken.Comment)
    {
        if (!reader.Read())
            throw new Exception(&amp;quot;Unexpected end.&amp;quot;);
    }

    switch (reader.TokenType)
    {
        case JsonToken.StartObject:
            return ReadObject(reader);
        case JsonToken.StartArray:
            return ReadList(reader);
        default:
            if (IsPrimitiveToken(reader.TokenType))
                return reader.Value;

            throw new Exception(string.Format(&amp;quot;Unexpected token when converting to Dictionary: {0}&amp;quot;, reader.TokenType));
    }
}

private bool IsPrimitiveToken(JsonToken token)
{
    switch (token)
    {
        case JsonToken.Integer:
        case JsonToken.Float:
        case JsonToken.String:
        case JsonToken.Boolean:
        case JsonToken.Undefined:
        case JsonToken.Null:
        case JsonToken.Date:
        case JsonToken.Bytes:
            return true;
        default:
            return false;
    }
}

private object ReadList(JsonReader reader)
{
    IList&amp;lt;object&amp;gt; list = new List&amp;lt;object&amp;gt;();

    while (reader.Read())
    {
        switch (reader.TokenType)
        {
            case JsonToken.Comment:
                break;
            default:
                object v = ReadValue(reader);

                list.Add(v);
                break;
            case JsonToken.EndArray:
                return list;
        }
    }

    throw new Exception(&amp;quot;Unexpected end.&amp;quot;);
}

private object ReadObject(JsonReader reader)
{
    IDictionary&amp;lt;string, object&amp;gt; dictionary = new Dictionary&amp;lt;string, object&amp;gt;();

    while (reader.Read())
    {
        switch (reader.TokenType)
        {
            case JsonToken.PropertyName:
                string propertyName = reader.Value.ToString();

                if (!reader.Read())
                    throw new Exception(&amp;quot;Unexpected end.&amp;quot;);

                object v = ReadValue(reader);

                dictionary[propertyName] = v;
                break;
            case JsonToken.Comment:
                break;
            case JsonToken.EndObject:
                return dictionary;
        }
    }

    throw new Exception(&amp;quot;Unexpected end.&amp;quot;);
}

public override void WriteJson(JsonWriter writer, object value, JsonSerializer serializer)
{
    IDictionary&amp;lt;string, object&amp;gt; dictionary = _converter.Serialize(value, _serializer);
    serializer.Serialize(writer, dictionary);
}
</code></pre>

<p>}</p>

<p>[/sourcecode]</p>

<p>Lastly, I needed to wrap the JSON.Net serializer within my IJsonSerializer interface so that my existing code can get all the benefit of its performance with little changes in my code.</p>

<p>[sourcecode language=&ldquo;csharp&rdquo;]</p>

<p>public class NewtonsoftJsonSerializer : IJsonSerializer
{</p>

<pre><code>private JsonSerializerSettings _settings = new JsonSerializerSettings();

public void RegisterConverters(IEnumerable&amp;lt;IJsonConverter&amp;gt; converters)
{
    foreach (IJsonConverter converter in converters)
        _settings.Converters.Add(new NewtonsoftJsonConverter(this, converter));
}

public T ConvertToType&amp;lt;T&amp;gt;(IDictionary&amp;lt;string, object&amp;gt; dictionary)
{
    string intermediate = JsonConvert.SerializeObject(dictionary);
    T value = JsonConvert.DeserializeObject&amp;lt;T&amp;gt;(intermediate);
    return value;
}

public T Deserialize&amp;lt;T&amp;gt;(string input)
{
    return JsonConvert.DeserializeObject&amp;lt;T&amp;gt;(input, _settings);
}

public string Serialize(object obj)
{
    return JsonConvert.SerializeObject(obj, Formatting.None, _settings);
}

public string DefaultSerialize(object obj)
{
    return JsonConvert.SerializeObject(obj);
}
</code></pre>

<p>}</p>

<p>[/sourcecode]</p>

<p>After changing a few import statements I was ready to go. Testing showed a particular server query that had been taking close to 2 minutes to return would now return in under 30 seconds consistently. This was certainly a huge win considering it required a very small set of changes to the project&rsquo;s code.</p>

<p>Overall the process went smoothly and I am very happy with the result. If you would like to use this code yourself, it is available as a <a href="https://gist.github.com/2331300" title="Gist on GitHub">Gist on GitHub</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Joey Robichaud</span></span>

      








  


<time datetime="2012-04-09T00:00:00-04:00" pubdate data-updated="true"></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.joeyrobichaud.com/blog/2012/04/09/from-javascriptserializer-to-jsonnet/" data-via="joeyrobichaud" data-counturl="http://www.joeyrobichaud.com/blog/2012/04/09/from-javascriptserializer-to-jsonnet/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/02/03/making-a-code-library/" title="Previous Post: Making a Code Library">&laquo; Making a Code Library</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/01/28/the-story-of-asfac/" title="Next Post: The Story of asfac">The Story of asfac &raquo;</a>
      
    </p>
  </footer>
</article>


</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/01/28/the-story-of-asfac/">The Story of asfac</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/09/from-javascriptserializer-to-jsonnet/">From JavaScriptSerializer to JSON.Net</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/03/making-a-code-library/">Making a Code Library</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/27/consolas-for-github/">Consolas for github</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/04/vibrantink-theme-for-flashdevelop/">VibrantInk Theme for FlashDevelop</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/joerobich">@joerobich</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'joerobich',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Joey Robichaud -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
